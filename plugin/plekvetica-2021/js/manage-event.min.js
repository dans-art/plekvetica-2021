"use strict";function ajaxPreloader(e){var t=new FormData;t.append("action","plek_ajax_event_form"),t.append("type","get_"+e),jQuery.ajax({url:window.ajaxurl,data:t,type:"POST",cache:!1,processData:!1,contentType:!1,success:function(t){if(t.length<2)return toastr.error(pleklang.loaderror+": "+e,"Error"),!1;var a=JSON.parse(t);return console.log(e+"-Data loaded ("+Object.keys(a).length+")"),"bands"===e?void(window.bandPreloadedData=a):"venues"===e&&void(window.venuePreloadedData=a)},error:function(e){return window.plekerror.display_info(window.pleklang.loaderror+": "+e,"Error"),!1}})}function show_end_date(){jQuery(".plek-multi-date").show()}function hide_end_date(){jQuery(".plek-multi-date").hide()}function disable_band_input(){jQuery("input#event_band").prop("disabled",!0),jQuery(".event-search-bar-container plek-button").addClass("disabled"),jQuery(".event-search-bar-container #event_band").addClass("disabled"),jQuery(".event-band-selection").hide()}function enable_band_input(){jQuery("input#event_band").prop("disabled",!1),jQuery(".event-search-bar-container plek-button").removeClass("disabled"),jQuery(".event-search-bar-container #event_band").removeClass("disabled"),jQuery(".event-band-selection").show()}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,a=new Array(e.length);t<e.length;t++)a[t]=e[t];return a}}var $=jQuery,flatpickr_options={locale:"de",enableTime:!0,dateFormat:"d-m-Y H:i:S",altInput:!0,altFormat:"j. F Y - H:i"};$(document).ready(function(){console.log("Ready!"),ajaxPreloader("bands"),ajaxPreloader("venues"),flatpickr("#event_start_date",flatpickr_options),flatpickr("#event_end_date",flatpickr_options),jQuery("#is_multiday").click(function(){jQuery(this).is(":checked")?show_end_date():hide_end_date()}),jQuery("#no_band").click(function(){jQuery(this).is(":checked")?(disable_band_input(),plekevent.remove_all_items("event-band-selection")):enable_band_input()}),jQuery("#event_start_date").change(function(){var e=jQuery("#event_start_date").val(),t=flatpickr_options;t.minDate=e,flatpickr("#event_end_date",t)}),jQuery("#plek-submit").click(function(e){e.preventDefault(),jQuery(this).prop("disabled",!0);var t=jQuery(this).data("type");window.plekevent.save_event(t)}),jQuery(".plek-search-input").focus(function(e){plektemplate.hide_overlay(),plektemplate.show_overlay(this)}),jQuery(".plek-search-input").keyup(function(e){0!==jQuery(this).val().length?pleksearch.fire_search(this):window.plektemplate.hide_overlay()})});var pleklang={loaderror:"Fehler beim Laden der Daten."},plekevent={existing_event:null,check_existing_event(){if(""!==this.get_field_value("event_start_date")){var e=new FormData;e.append("action","plek_ajax_event_form"),e.append("type","check_event_duplicate"),e.append("start_date",this.get_field_value("event_start_date")),e.append("band_ids",JSON.stringify(this.get_field_value("bands"))),console.log(e),jQuery.ajax({url:window.ajaxurl,data:e,type:"POST",cache:!1,processData:!1,contentType:!1,success:function(e){var t=JSON.parse(e);return""!==t.error?(window.plekerror.display_info("Achtung",t.error),this.existing_event=!0,console.log("Event Existiert beriets"),!0):(this.existing_event=!1,console.log("Event existiert nicht"),!1)},error:function(e){return window.plekerror.display_info(window.pleklang.loaderror+": "+e,"Error"),!1}})}return null},add_item_to_selection(e){var t=jQuery(e).data("for"),a=jQuery(e).data("type"),r={id:jQuery(e).data("id"),name:jQuery(e).html()};jQuery("#"+t).append(plektemplate.get_item_to_add(r)),plektemplate.hide_overlay(),jQuery("#"+a).val(""),plekevent.add_remove_item_eventlistener(),"event_band"===a&&window.plekevent.check_existing_event()},add_remove_item_eventlistener(){jQuery(".remove-item").click(function(){jQuery(this).parent().parent().remove()})},remove_all_items(e){jQuery("#"+e+" .item").remove()},save_event(e){if(console.log("save"+e),!plekvalidator.validate_data())return jQuery("#plek-submit").prop("disabled",!1),!1;var t=this.prepare_data(e);jQuery.ajax({url:window.ajaxurl,data:t,type:"POST",cache:!1,processData:!1,contentType:!1,success:function(e){jQuery("#plek-submit").prop("disabled",!1);var t=JSON.parse(e);return""!==t.error?(window.plekerror.display_info("Achtung",t.error),this.existing_event=!0,console.log("Event Existiert beriets"),!0):(this.existing_event=!1,console.log("Event existiert nicht"),!1)},error:function(e){return window.plekerror.display_info(window.pleklang.loaderror+": "+e,"Error"),!1}})},prepare_data(e){var t=new FormData;return t.append("action","plek_ajax_event_form"),t.append("type",e),"save_basic_event"===e&&(t.append("name",this.get_field_value("event_name")),t.append("start_date",this.get_field_value("event_start_date")),jQuery("#is_multiday").is(":checked")&&t.append("end_date",this.get_field_value("event_end_date")),t.append("band_ids",JSON.stringify(this.get_field_value("bands"))),t.append("venue",this.get_field_value("venue")),t.append("description",this.get_field_value("event_description"))),t},get_field_value(e){switch(e){case"bands":return this.get_selector_ids("event-band-selection");case"venue":return this.get_selector_ids("event-venue-selection");default:return jQuery("#"+e).val()}},get_selector_ids(e){var t=[],a=jQuery("#"+e).find(".plek-select-item");return jQuery.each(a,function(e,a){var r=jQuery(a).data("id");t.push(r)}),1===t.length?t[0]:t}},plekerror={display_error(e,t){console.log(e),console.log(t),toastr.error(e,t)},display_info(e,t){console.log(e),console.log(t),toastr.info(e,t)}},plekvalidator={validate_data:()=>(plekerror.display_error("Validator","Nicht validiert!"),!0)},evaluation=function(e,t,a){return e==t?a.match:a.mismatch},createMatrix=function(e,t){return _toConsumableArray(new Array(e)).map(function(e){return _toConsumableArray(new Array(t)).map(function(e){return 1})})},initXAxis=function(e,t){return e.map(function(e,a){return a?e:e.map(function(e){return t})})},initYAxis=function(e,t){return e.map(function(e){return e.map(function(e,a){return 0===a?t:0})})},tracebackDirectionHash=["d","u","l"],F=function(e,t,a,r){var n="",i=[+a.matches[t-1][e-1]+evaluation(a.sequence[e-1],a.pattern[t-1],r),+a.matches[t-1][e]+r.gap,+a.matches[t][e-1]+r.gap],l=Math.max.apply(Math,i);return i.filter(function(e){return l===e}).length>1&&i[0]===l&&l>0?n=tracebackDirectionHash[0]:1==i.filter(function(e){return l===e}).length&&l>0?n=tracebackDirectionHash[i.indexOf(l)]:l<=0&&(n=0,l=0),[l,n]},matrix=function(e,t){return{sequence:e,pattern:t,matches:createMatrix(t.length+1,e.length+1),traceback:createMatrix(t.length+1,e.length+1),peak:{cell:{},value:0},initalizeMatrix:function(){this.matches=initXAxis(initYAxis(this.matches,0),0),this.traceback=initXAxis(initYAxis(this.matches,0),0),this.traceback[0][0]=0},computeScore:function(e){var t=this,a=this.traceback;this.traceback=a.map(function(a,r){return 0===r?a:a.map(function(a,n){if(0===n)return a;var i=F(n,r,t,e);return t.peak.value<=i[0]&&(t.peak.cell={x:+n,y:+r},t.peak.value=i[0]),t.matches[r][n]=i[0],i[1]})})},trace:[],getTrace:function(){for(var e=0,t=$.extend({},this.peak.cell);0!==this.traceback[t.y][t.x]&&!(e>20);)e+=1,"d"===this.traceback[t.y][t.x]?(this.trace.push({seqChar:this.sequence[t.x-1],patChar:this.pattern[t.y-1],seqIndex:t.x,patIndex:t.y}),t.x-=1,t.y-=1):"u"===this.traceback[t.y][t.x]?(this.trace.push({seqChar:"-",patChar:this.pattern[t.y-1],seqIndex:t.x,patIndex:t.y}),t.x-=1):"l"===this.traceback[t.y][t.x]&&(this.trace.push({seqChar:this.sequence[t.x-1],patChar:"-",seqIndex:t.x,patIndex:t.y}),t.y-=1)}}},smith_waterman=function(e,t,a){var r=matrix(e,t);return r.initalizeMatrix(),r.computeScore(a),r.getTrace(),r},pleksearch={current_type:null,treshhold:60,fire_search(e){var t=jQuery(e).attr("id"),a=jQuery("#"+t).attr("name"),r=jQuery("#"+a+"_overlay");if(this.set_type_settings(a),0!=r.length){r.html("<div class='item'><span class='plek_loading'></span>&nbsp;Lade Ergebnise....</div>");var n=window.plekTimeout;window.clearTimeout(n),window.plekTimeout=window.setTimeout(function(){window.pleksearch.search(t).then(function(e){r.html(pleksearch.display_results(e)),window.pleksearch.add_item_Eventlistener()})},500)}else plekerror.display_error("No Result Container found.")},set_type_settings(e){switch(window.pleksearch.current_type=e,e){case"event_venue":window.pleksearch.threshhold=40;break;case"event_band":window.pleksearch.threshhold=60}},display_results(e){var t="",a=Object.keys(e).length;return t=plektemplate.load_search_overlay_header(a),jQuery.each(e,function(e,a){switch(window.pleksearch.current_type){case"event_band":t+=plektemplate.load_band_item_template(a.data);break;case"event_venue":t+=plektemplate.load_venue_item_template(a.data)}}),t},add_item_Eventlistener(){jQuery(".plek-add-item").click(function(e){window.plekevent.add_item_to_selection(this)})},async search(e){var t=jQuery("#"+e).val().toLowerCase().replace(/[^a-z 0-9]/,""),a=window.pleksearch.current_type;return pleksearch.get_preloaded_data(a).then(function(e){var r={};return jQuery.each(e,function(e,n){var i=n.name.toLowerCase().replace(/[^a-z 0-9]/,""),l=smith_waterman(t,i,{match:10,mismatch:-1,gap:-1}),s=pleksearch.is_exact_hit(t,i);if(l.peak.value>=window.pleksearch.threshhold||s>0||!0===s){console.log("compare: "+i+" :: "+t+" - "+l.peak.value+"%");var o={};o.type=a,o.data=n,o.class=!0===s||100===l.peak.value?"exact-hit":"",o.perc=!0===s?100:l.peak.value,r[n.id]=o}}),new Promise(e=>{e(pleksearch.sort_results(r))})})},sort_results:e=>e,is_exact_hit(e,t){var a=t.search(e);return 0===a&&t.length===e.length||e===t||a},async get_preloaded_data(e){return new Promise(t=>{t(this.get_preloaded_object(e))})},get_preloaded_object(e){if("event_band"===e)t=window.bandPreloadedData;else if("event_venue"===e)var t=window.venuePreloadedData;return t}},plektemplate={load_template(e,t){var a=e;return con(`${e}`),jQuery.each(t,function(e,t){a=a.replace("%%"+e+"%%",t)}),a},load_band_item_template(e){var t=this.get_flag_image(e.flag);return`<div class='item plek-add-item' data-for='event-band-selection' data-type='event_band' data-id='${e.id}'>\n        <div class='title'>\n        <img src="${t}"/>\n        <span class='item-title'>${e.name}</span></div>\n        <div class='subtitle'>${e.genres}</div>\n        </div>`},load_venue_item_template:e=>`<div class='item plek-add-item' data-for='event-venue-selection' data-type='event_venue' data-id='${e.id}'>\n        <div class='title'>\n        <span class='item-title'>${e.name}</span></div>\n        <div class='subtitle'>${e.address}, ${e.zip} ${e.city}<span class='country'>${e.country}</span></div>\n        </div>`,load_search_overlay_header:e=>`<div class="overlay-header">Einträge gefunden: ${e}</div>`,get_template:e=>jQuery(e).get(0).outerHTML,show_overlay(e){var t=jQuery(e).attr("name");jQuery("#"+t+"_overlay").show(),window.plektemplate.activate_overlay_background(e)},hide_overlay(){console.log("Hide Overlay"),jQuery(".plek-search-overlay").hide(),window.plektemplate.deactivate_overlay_background()},activate_overlay_background(e){var t=jQuery(document).height();jQuery(e).css("z-index",20),jQuery(".overlay_background").height(t),jQuery(".overlay_background").click(function(){window.plektemplate.hide_overlay()})},deactivate_overlay_background(){jQuery(".overlay_background").height(0),jQuery(".overlay_background").off("click")},prepare_data(e){console.log(e);var t=new Object;return t.id=e.data.id,t.name=e.data.name,t.class=e.class,t.genres=void 0!==e.data.id?e.data.id:"",t.flag=void 0!==e.data.flag?this.get_flag_image(e.data.flag):"",t},get_flag_image:e=>e.length<1?"":window.plek_plugin_dir_url+"images/flags/"+e+".png",get_item_to_add:e=>`<div class='item plek-select-item' data-id='${e.id}'>\n            <div class='title'>\n            <span class='remove-item'><i class="fas fa-times"></i></span>\n            <span class='item-title'>${e.name}</span>\n            </div>\n        </div>`};