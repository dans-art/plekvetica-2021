var plekevent={existing_event:null,construct(){plekevent.add_events_listener()},add_events_listener(){jQuery("#event_start_date").on("change",(function(){window.plekevent.check_existing_event()}))},check_existing_event(){if(""!==this.get_field_value("event_start_date")&&jQuery("#event-band-selection .item").length>0){var datab=new FormData;datab.append("action","plek_ajax_event_form"),datab.append("type","check_event_duplicate"),datab.append("start_date",this.get_field_value("event_start_date")),datab.append("band_ids",JSON.stringify(this.get_field_value("bands"))),console.log(datab),jQuery.ajax({url:window.ajaxurl,data:datab,type:"POST",cache:!1,processData:!1,contentType:!1,success:function success(data){var jdata=JSON.parse(data);return""!==jdata.error?(window.plekerror.display_info("Achtung",jdata.error),plekevent.existing_event=!0,console.log("Event Existiert bereits"),!0):(plekevent.existing_event=!1,console.log("Event existiert nicht"),!1)},error:function error(data){return window.plekerror.display_info(window.pleklang.loaderror+": "+data,"Error"),!1}})}return null},add_item_to_selection(element){var item_for=jQuery(element).data("for"),type=jQuery(element).data("type"),item_id=jQuery(element).data("id"),html,data={id:item_id,name:jQuery(element).html()};0===jQuery(`.plek-select-item[data-id='${item_id}']`).length&&jQuery("#"+item_for).append(plektemplate.get_item_to_add(data)),plektemplate.hide_overlay(),jQuery("#"+type).val(""),plekevent.add_remove_item_eventlistener(),"event_band"===type&&(window.plekevent.check_existing_event(),window.plekevent.generate_title())},add_remove_item_eventlistener(){jQuery(".remove-item").click((function(){jQuery(this).parent().parent().remove()}))},remove_all_items(selector){jQuery("#"+selector+" .item").remove()},save_event(type){console.log("save"+type);var datab=this.prepare_data(type);if(!0!==plekvalidator.validate_form_data(datab))return jQuery("#plek-submit").prop("disabled",!1),plekvalidator.display_errors(),!1;jQuery.ajax({url:window.ajaxurl,data:datab,type:"POST",cache:!1,processData:!1,contentType:!1,success:function success(data){jQuery("#plek-submit").prop("disabled",!1);var jdata=JSON.parse(data);return""!==jdata.error?(window.plekerror.display_info("Achtung",jdata.error),this.existing_event=!0,console.log("Event Existiert beriets"),!0):(this.existing_event=!1,console.log("Event existiert nicht"),!1)},error:function error(data){return window.plekerror.display_info(window.pleklang.loaderror+": "+data,"Error"),!1}})},save_event_login(type){console.log("savelogin"+type);var datab=this.prepare_data(type);if(!0!==plekvalidator.validate_form_data(datab))return jQuery("#plek-add-login-submit").prop("disabled",!1),plekvalidator.display_errors(),!1;jQuery.ajax({url:window.ajaxurl,data:datab,type:"POST",cache:!1,processData:!1,contentType:!1,success:function success(data){jQuery("#plek-add-login-submit").prop("disabled",!1);var jdata=JSON.parse(data);if(0!==jdata.error.length)return window.plekerror.display_error(plek_main.get_first_error_from_ajax_request(jdata),__("Error","pleklang")),!1;{let content=plek_main.get_ajax_success_object(jdata);jQuery(".plek-form").parent().html(content);let url=plek_main.url_replace_param("stage","details");return window.history.pushState({},"Add Event details",url),document.title=__("Add Event details","pleklang")+" - Plekvetica",!0}},error:function error(data){return window.plekerror.display_info(window.pleklang.loaderror+": "+data,"Error"),!1}})},prepare_data(type){var datab=new FormData;if(datab.append("action","plek_ajax_event_form"),datab.append("type",type),"save_basic_event"===type&&(datab.append("event_name",this.get_field_value("event_name")),datab.append("event_start_date",this.get_field_value("event_start_date")),!0===jQuery("#is_multiday").is(":checked")&&(datab.append("event_end_date",this.get_field_value("event_end_date")),plekvalidator.add_field("event_end_date","date")),!0===jQuery("#no_band").is(":checked")?(datab.append("no_bands_known","true"),plekvalidator.add_field("event_band","int",!0)):plekvalidator.add_field("event_band","int"),datab.append("event_band",this.get_field_value("bands")),datab.append("event_venue",this.get_field_value("venue")),plekvalidator.add_field("event_name","text"),plekvalidator.add_field("event_start_date","date"),plekvalidator.add_field("event_venue","int")),"save_event_details"===type&&(datab.append("event_description",this.get_field_value("event_description")),datab.append("event_organizer",this.get_field_value("event_organizer")),datab.append("event_poster",this.get_field_value("event_poster")),datab.append("event_fb_link",this.get_field_value("event_fb_link")),datab.append("event_price_boxoffice",this.get_field_value("event_price_boxoffice")),datab.append("event_price_boxoffice_currency",this.get_field_value("event_price_boxoffice_currency")),datab.append("event_price_presale",this.get_field_value("event_price_presale")),datab.append("event_price_presale_currency",this.get_field_value("event_price_presale_currency")),datab.append("event_price_link",this.get_field_value("event_price_link")),datab.append("event_id",this.get_field_value("event_id")),plekvalidator.add_field("event_description","text"),plekvalidator.add_field("event_organizer","int"),plekvalidator.add_field("event_poster","file"),plekvalidator.add_field("event_fb_link","url"),plekvalidator.add_field("event_price_boxoffice","price"),plekvalidator.add_field("event_price_boxoffice_currency","simpletext"),plekvalidator.add_field("event_price_presale","price"),plekvalidator.add_field("event_price_presale_currency","simpletext"),plekvalidator.add_field("event_price_link","url"),plekvalidator.add_field("event_id","int"),plekvalidator.add_error_messages("event_id",__("Missing Event ID","pleklang"))),"save_add_event_login"===type){let selected_btn;"add_login"===jQuery("#select-login-type a.selected").attr("id")?(datab.append("user_login",this.get_field_value("user_login")),datab.append("user_pass",this.get_field_value("user_pass")),datab.append("rememberme",this.get_field_value("rememberme")),plekvalidator.add_field("user_login","text"),plekvalidator.add_field("user_pass","password"),plekvalidator.add_field("rememberme","text",!0)):(datab.append("guest_name",this.get_field_value("guest_name")),datab.append("guest_email",this.get_field_value("guest_email")),plekvalidator.add_field("guest_name","text"),plekvalidator.add_field("guest_email","email")),datab.append("event_id",this.get_field_value("event_id")),plekvalidator.add_field("event_id","int"),plekvalidator.add_error_messages("event_id",__("Missing Event ID","pleklang"))}return datab},get_field_value(name){let type;switch(jQuery("#"+name).attr("type")){case"checkbox":return jQuery("#"+name+":checked").length>0?jQuery("#"+name).val():"";case"file":let file_data;return jQuery("#"+name).prop("files")[0]}switch(name){case"bands":return this.get_selector_ids("event-band-selection");case"venue":return this.get_selector_ids("event-venue-selection");case"event_organizer":return this.get_selector_ids("event-organizer-selection");default:return jQuery("#"+name).val()}},get_selector_ids(selector_id){var ids=[],items=jQuery("#"+selector_id).find(".plek-select-item");return jQuery.each(items,(function(key,val){var id=jQuery(val).data("id");ids.push(id)})),0===Object.keys(ids).length?"":JSON.stringify(ids)},generate_title(){let selected_bands=jQuery("#event-band-selection .item");var title_input=jQuery("#event_name"),band_order=[];jQuery.each(selected_bands,(function(index){let id=jQuery(this).data("id"),band_name=bandPreloadedData[id].name,band_score=parseInt(bandPreloadedData[id].score);band_order.push([band_score,band_name])})),band_order.sort((function(a,b){var a0=a[0],b0=b[0];return a0==b0?0:a0<b0?1:-1}));var total_items=band_order.length,event_name_text="";jQuery.each(band_order,(function(index){0!==index?event_name_text+=index+1!==total_items?", "+this[1]:" & "+this[1]:event_name_text=this[1]})),jQuery(title_input).val(event_name_text)}};plekevent.construct();