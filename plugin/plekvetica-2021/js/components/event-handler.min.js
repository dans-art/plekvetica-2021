var plekevent={existing_event:null,construct(){plekevent.add_events_listener()},add_events_listener(){jQuery("#event_start_date").on("change",(function(){window.plekevent.check_existing_event()}))},check_existing_event(){if(""!==this.get_field_value("event_start_date")&&jQuery("#event-band-selection .item").length>0){var datab=new FormData;datab.append("action","plek_ajax_event_form"),datab.append("type","check_event_duplicate"),datab.append("start_date",this.get_field_value("event_start_date")),datab.append("band_ids",this.get_field_value("event_band")),console.log(datab),jQuery.ajax({url:window.ajaxurl,data:datab,type:"POST",cache:!1,processData:!1,contentType:!1,success:function success(data){var jdata=JSON.parse(data);return jdata.error.length>0?(window.plekerror.set_toastr(0,!0,"toast-bottom-full-width"),window.plekerror.display_info(__("Event already exists","pleklang"),jdata.error),window.plekerror.reset_toastr(),plekevent.existing_event=!0,console.log("Event Existiert bereits"),!0):(plekevent.existing_event=!1,console.log("Event existiert nicht"),!1)},error:function error(data){return window.plekerror.display_info(window.pleklang.loaderror+": "+data,"Error"),!1}})}return null},add_new_vob_to_selection(type,vob_id,data){switch(type){case"band-form-submit":window.bandPreloadedData=data;let band=window.bandPreloadedData[vob_id],ele_b=plektemplate.load_band_item_template(band);this.add_item_to_selection(ele_b),plekerror.display_info(__("Add Band","pleklang"),__("The Band has been added to the Database","pleklang"));break;case"venue-form-submit":window.venuePreloadedData=data;let venue=window.venuePreloadedData[vob_id],ele_v=plektemplate.load_venue_item_template(venue);this.add_item_to_selection(ele_v),plekerror.display_info(__("Add Veneu","pleklang"),__("The Venue has been added to the Database","pleklang"));break;case"orgnaizer-form-submit":window.organizerPreloadedData=data;let organizer=window.organizerPreloadedData[vob_id],ele_o=plektemplate.load_organizer_item_template(organizer);this.add_item_to_selection(ele_o),plekerror.display_info(__("Add Organizer","pleklang"),__("The Organizer has been added to the Database","pleklang"));break;default:return!1}return!0},add_item_to_selection(element){var item_for=jQuery(element).data("for"),type=jQuery(element).data("type"),item_id=jQuery(element).data("id"),html,data={id:item_id,name:jQuery(element).html()};"event_venue"===type&&this.remove_all_items("event-venue-selection"),0===jQuery(`.plek-select-item[data-id='${item_id}']`).length&&jQuery("#"+item_for).append(plektemplate.get_item_to_add(data)),plektemplate.hide_overlay(),jQuery("#"+type).val(""),plekevent.add_remove_item_eventlistener(),"event_band"===type&&(window.plekevent.check_existing_event(),window.plekevent.generate_title(),this.set_band_time_flatpickr())},set_band_time_flatpickr(){let defaultStartDate="2020-01-01",defaultEndDate="9020-01-01";if(this.event_is_single_day())plek_manage_event.flatpickr_band_options.time_24hr=!0,plek_manage_event.flatpickr_band_options.dateFormat="H:i",plek_manage_event.flatpickr_band_options.altFormat="H:i",plek_manage_event.flatpickr_band_options.defaultDate="20:00",plek_manage_event.flatpickr_band_options.noCalendar=!0;else{let startDate=this.get_event_date("event_start_date","date"),endDate=this.get_event_date("event_end_date","date");startDate=0===startDate.length?"2020-01-01":startDate,endDate=0===endDate.length?"9020-01-01":endDate,plek_manage_event.flatpickr_band_options.enable=[{from:startDate,to:endDate}]}flatpickr("#event-band-selection .band-time-input",plek_manage_event.flatpickr_band_options)},add_remove_item_eventlistener(){jQuery(".remove-item").click((function(){jQuery(this).parent().parent().remove()}))},remove_all_items(selector){jQuery("#"+selector+" .item").remove()},save_event(type,form){console.log("save "+type);var datab=this.prepare_data(type);if(!0!==plekvalidator.validate_form_data(datab,form))return jQuery("#"+form).prop("disabled",!1),plekvalidator.display_errors(form),!1;let button=jQuery("#"+form+" .plek-main-submit-button"),orig_btn_text=button.val();plek_main.activate_loader_style(button),jQuery.ajax({url:window.ajaxurl,data:datab,type:"POST",cache:!1,processData:!1,contentType:!1,success:function success(data){let text=plek_main.get_text_from_ajax_request(data,!0),errors;if(!0===plek_main.show_field_errors(data,"#add_event_basic"))console.log("Contains Errors"),text="Das Formular enthält Fehler, bitte korrigieren",plek_main.deactivate_button_loader(button,orig_btn_text),jQuery(button).prop("disabled",!1);else{let success_obj=plek_main.get_ajax_success_object(data),event_id=void 0!==success_obj[0]?success_obj[0]:"000",user_id=void 0!==success_obj[1]?success_obj[1]:0,event_url=void 0!==success_obj[2]?success_obj[2]:"";plek_main.url_replace_param("event_id",event_id);var stage="login";"save_basic_event"===type&&user_id>0&&(stage="details");let url=plek_main.url_replace_param("stage",stage);if("save_event_details"===type)if(0===user_id)plekerror.display_info(__("Event saved, thanks a lot!<br/>Our Eventmanager will check and publish the Event","pleklang"));else{let event_url_label,event_url_html=`<a href='${event_url}'>${__("To my Event","pleklang")}</a>`;plekerror.display_info(__("Event saved! Check it out here: "+event_url_html,"pleklang"))}else plekerror.display_info(__("Event saved!","pleklang")),setTimeout(()=>{window.location=url},500)}},error:function error(data){plek_main.deactivate_button_loader(button,__("Error loading data.... ","pleklang"))}})},save_event_login(type){console.log("savelogin "+type);var form="add_event_login",datab=this.prepare_data(type);if(!0!==plekvalidator.validate_form_data(datab,form))return jQuery("#plek-add-login-submit").prop("disabled",!1),plekvalidator.display_errors(form),!1;jQuery.ajax({url:window.ajaxurl,data:datab,type:"POST",cache:!1,processData:!1,contentType:!1,success:function success(data){let errors;if(jQuery("#plek-add-login-submit").prop("disabled",!1),!0===plek_main.show_field_errors(data,"#add_event_login"))console.log("Contains Errors"),text="Das Formular enthält Fehler, bitte korrigieren";else{let success_obj=plek_main.get_ajax_success_object(data),event_id=void 0!==success_obj[0]?success_obj[0]:"000",user_id=void 0!==success_obj[1]?success_obj[1]:0;plek_main.url_replace_param("event_id",event_id);let url=plek_main.url_replace_param("stage","details");window.location=url}},error:function error(data){return window.plekerror.display_info(window.pleklang.loaderror+": "+data,"Error"),!1}})},prepare_data(type){var datab=new FormData;if(datab.append("action","plek_ajax_event_form"),datab.append("type",type),"save_basic_event"===type){datab.append("event_name",this.get_field_value("event_name")),datab.append("event_start_date",this.get_field_value("event_start_date")),!0===jQuery("#is_multiday").is(":checked")&&(plekvalidator.add_field("is_multiday","int",!0),plekvalidator.add_field("event_end_date","date",!0)),datab.append("is_multiday",!0===jQuery("#is_multiday").is(":checked")?"1":"0"),datab.append("event_end_date",this.get_field_value("event_end_date")),!0===jQuery("#no_band").is(":checked")?(datab.append("no_bands_known","true"),plekvalidator.add_field("event_band","int",!0)):plekvalidator.add_field("event_band","int"),datab.append("event_band",this.get_field_value("event_band")),datab.append("event_venue",this.get_field_value("event_venue")),datab.append("hp-password",this.get_field_value("hp-password"));let band_order_time=this.get_band_order_time();datab.append("band_order_time",band_order_time)}if("save_event_details"===type&&(datab.append("event_description",this.get_field_value("event_description")),datab.append("event_organizer",this.get_field_value("event_organizer")),datab.append("event_poster",this.get_field_value("event_poster")),datab.append("event_fb_link",this.get_field_value("event_fb_link")),datab.append("event_price_boxoffice",this.get_field_value("event_price_boxoffice")),datab.append("event_price_boxoffice_currency",this.get_field_value("event_price_boxoffice_currency")),datab.append("event_price_presale",this.get_field_value("event_price_presale")),datab.append("event_price_presale_currency",this.get_field_value("event_price_presale_currency")),datab.append("event_price_link",this.get_field_value("event_price_link")),datab.append("event_id",this.get_field_value("event_id"))),"save_add_event_login"===type){plek_manage_event.prepare_validator_fields();let selected_btn=jQuery("#select-login-type a.selected").attr("id");"add_login"===selected_btn?(datab.append("user_login",this.get_field_value("user_login")),datab.append("user_pass",this.get_field_value("user_pass")),datab.append("rememberme",this.get_field_value("rememberme"))):(datab.append("guest_name",this.get_field_value("guest_name")),datab.append("guest_email",this.get_field_value("guest_email"))),datab.append("event_id",this.get_field_value("event_id"));let is_guest="add_as_guest"===selected_btn;datab.append("is_guest",is_guest)}return console.log("Added Validator fields for: "+type),datab},get_band_order_time(){let order_obj={},is_single_day_event=this.event_is_single_day();return jQuery("#event-band-selection .plek-select-item").each((index,item)=>{let band_id=jQuery(item).data("id"),datetime=jQuery(item).find(".band-time-input").first().val();if(is_single_day_event||datetime.length<6){let startDate;datetime=this.get_event_date("event_start_date","date")+" "+datetime}order_obj[band_id]={order:index,datetime:datetime}}),JSON.stringify(order_obj)},event_is_single_day(){let startDate=jQuery("#event_start_date").val(),startDateArr=startDate.split(" "),endDate=jQuery("#event_end_date").val(),endDateArr=endDate.split(" ");if(0===endDate.length)return!0;if(startDateArr[0]===endDateArr[0])return!0;let startDD=new Date(startDate),endDD=new Date(endDate),nextDay=startDD.setTime(startDD.getTime()+576e5);return new Date(nextDay)>endDD},get_event_date(id=null,output="both"){let dateVal=jQuery("#"+id).val();if(void 0===dateVal)return"";let dateSplit=dateVal.split(" ");switch(output){case"date":return dateSplit[0];case"time":return void 0!==dateSplit[1]?dateSplit[1]:"";default:return dateSplit}},get_field_value(name){let type=jQuery("#"+name).attr("type");switch(void 0===type&&(type=jQuery("#"+name).prop("type")),type){case"checkbox":return jQuery("#"+name+":checked").length>0?jQuery("#"+name).val():"";case"textarea":return void 0!==tinymce.editors[name]?tinymce.editors[name].getContent():jQuery("#"+name+":checked").length>0?jQuery("#"+name).val():"";case"file":let file_data;return jQuery("#"+name).prop("files")[0]}switch(name){case"event_band":return this.get_selector_ids("event-band-selection");case"event_venue":return this.get_selector_ids("event-venue-selection");case"event_organizer":return this.get_selector_ids("event-organizer-selection");default:return jQuery("#"+name).val()}},get_selector_ids(selector_id){var ids=[],items=jQuery("#"+selector_id).find(".plek-select-item");return jQuery.each(items,(function(key,val){var id=jQuery(val).data("id");ids.push(id)})),0===Object.keys(ids).length?"":JSON.stringify(ids)},generate_title(){let selected_bands=jQuery("#event-band-selection .item");var title_input=jQuery("#event_name"),band_order=[];jQuery.each(selected_bands,(function(index){let id=jQuery(this).data("id"),band_name=bandPreloadedData[id].name,band_score=parseInt(bandPreloadedData[id].score);band_order.push([band_score,band_name])})),band_order.sort((function(a,b){var a0=a[0],b0=b[0];return a0==b0?0:a0<b0?1:-1}));var total_items=band_order.length,event_name_text="";jQuery.each(band_order,(function(index){0!==index?event_name_text+=index+1!==total_items?", "+this[1]:" & "+this[1]:event_name_text=this[1]})),jQuery(title_input).val(event_name_text)}};plekevent.construct();