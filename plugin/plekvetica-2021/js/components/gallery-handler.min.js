var plek_gallery_handler={nonce:null,album_ids:null,max_upload_size:0,construct(){this.max_upload_size=1048576,jQuery(".image_upload_add_btn").on("click",(function(event){plek_gallery_handler.add_images_click_action(this)})),jQuery("#review_images_upload_btn").on("click",(function(event){plek_gallery_handler.upload_images_click_action(this)})),jQuery("#images-uploaded-container").on("click",".image_to_upload.upload_complete",(function(event){plek_gallery_handler.set_gallery_preview_click_action(this)})),jQuery("#review_images").on("change",(function(event){plek_gallery_handler.image_upload_form_change_action(this)})),jQuery(document).ready(()=>{jQuery("#event-review-images-container").sortable()})},create_gallery(event_id,band_id,album_id){var datab=new FormData;return datab.append("action","plek_ajax_gallery_actions"),datab.append("do","add_gallery"),datab.append("event_id",event_id),datab.append("album_id",album_id),datab.append("band_id",band_id),jQuery.ajax({url:ajaxurl,data:datab,type:"POST",cache:!1,processData:!1,contentType:!1,dataFilter:function(data){if(plek_main.response_has_errors(data))return plek_main.show_field_errors(data),!1;{let response=plek_main.get_first_success_from_ajax_request(data);return!empty(response)&&response}},error:function error(data){return!1}})},create_album(event_id="",band_id=""){var datab=new FormData;return datab.append("action","plek_ajax_gallery_actions"),datab.append("do","add_album"),datab.append("event_id",event_id),datab.append("band_id",band_id),jQuery.ajax({url:ajaxurl,data:datab,type:"POST",cache:!1,processData:!1,contentType:!1,dataFilter:function(data){if(plek_main.response_has_errors(data))return plek_main.show_field_errors(data),!1;{let response=plek_main.get_first_success_from_ajax_request(data),is_multiday;return plek_main.get_success_item_from_ajax_request(data,2)||jQuery(".review_band_images_container .image_upload_add_btn").data("album_id",response),!empty(response)&&response}},error:function error(data){return!1}})},async add_images_click_action(button){let img_con=jQuery("#event-review-images-upload-container"),album_gallery_created;if(plek_main.activate_button_loader(button),!0===plek_gallery_handler.lock_add_images_button)return void plekerror.display_error(null,__("Please wait for the album and galleries to be created.","pleklang"));plek_gallery_handler.lock_add_images_button=!0,img_con.hide(),await plek_gallery_handler.check_album_and_gallery_ids(button)||plekerror.display_error(null,__("Error while creating album or gallery","pleklang"),__("Error","pleklang")),plek_main.deactivate_button_loader(button);let band_id=jQuery(button).attr("data-band_id"),gallery_id=jQuery(button).attr("data-gallery_id"),album_id=jQuery(button).attr("data-album_id"),upload_btn=img_con.find("#review_images_upload_btn");img_con.show();let band_name=jQuery(button).parent().find(".band_name").text(),band_playtime=jQuery(button).parent().find(".playtime").text();jQuery("#event-review-images-upload-container").find(".gallery_title").text(band_playtime+" "+band_name),jQuery("#images-uploaded-container").html(""),jQuery("#review_images").val(""),upload_btn.attr("data-gallery_id",gallery_id),upload_btn.attr("data-album_id",album_id),upload_btn.attr("data-band_id",band_id),this.update_gallery_button_status(gallery_id,"done");let pos_top=img_con.position().top,win_height=jQuery(window).height()/2;jQuery("html").animate({scrollTop:pos_top-win_height},600),plek_gallery_handler.lock_add_images_button=!1},async check_album_and_gallery_ids(button){try{let gallery_id=jQuery(button).attr("data-gallery_id"),album_id=jQuery(button).attr("data-album_id"),event_id=jQuery("#event_id").val(),band_id=jQuery(button).attr("data-band_id");if(empty(album_id)){let new_album_id=await plek_gallery_handler.create_album(event_id,band_id);if(!1===new_album_id)return console.log(__("Error while creating a new album","pleklang")),!1;album_id=new_album_id,jQuery(button).attr("data-album_id",new_album_id),console.log("album created: "+new_album_id)}if(empty(gallery_id)){let new_gallery_id=await plek_gallery_handler.create_gallery(event_id,band_id,album_id);if(!1===new_gallery_id)return console.log(__("Error while creating a new gallery","pleklang")),!1;jQuery(button).attr("data-gallery_id",new_gallery_id),console.log("Gallery added: "+new_gallery_id)}return!0}catch(error){return console.log(error),!1}},update_gallery_button_status(gallery_id,status_type){let css_status="";switch(status_type){case"done":css_status="status-ok";break;case"uploading":css_status="status-uploading";break;default:css_status="status-missing"}let button=jQuery(`.image_upload_add_btn[data-gallery_id='${gallery_id}']`).find(".image_upload_status");button.removeClass("status-missing"),button.removeClass("status-ok"),button.removeClass("status-uploading"),button.addClass(css_status)},async upload_images_click_action(button){let gallery_id=jQuery(button).attr("data-gallery_id"),album_id=jQuery(button).attr("data-album_id"),files=jQuery("#review_images").prop("files");if(0!==files.length){this.update_gallery_button_status(gallery_id,"uploading"),plek_main.activate_button_loader("#review_images_upload_btn",__("Uploading images...","pleklang"));for(let index=0;index<files.length;index++){let upload=files[index];if(upload.size>plek_gallery_handler.max_upload_size)return;let formdata=new FormData;formdata.append("file_data",upload);let container="#images-uploaded-container",item=jQuery(container+" .image_to_upload")[index];jQuery(container).attr("data-album_id",album_id),jQuery(container).attr("data-gallery_id",gallery_id),jQuery(item).addClass("upload_in_progress"),jQuery(item).addClass("current_upload"),await plek_gallery_handler.upload_image(index,formdata,gallery_id)}}else plekerror.display_error(null,__("No Images selected!","pleklang"),"Image upload error")},set_gallery_preview_click_action(image){let gallery_id=jQuery(image).parent().attr("data-gallery_id"),image_id=jQuery(image).attr("data-image_id"),img_element=jQuery(image).find("img");plek_main.activate_loader_style(img_element);let formdata=new FormData;formdata.append("action","plek_ajax_gallery_actions"),formdata.append("do","set_preview_image"),formdata.append("gallery_id",gallery_id),formdata.append("image_id",image_id),jQuery.ajax({url:ajaxurl,data:formdata,type:"POST",cache:!1,processData:!1,contentType:!1,async:!1,success:function success(data){console.log("uploaded"),plek_main.response_has_errors(data)?plekerror.display_error("",plek_main.get_first_error_from_ajax_request(data),__("Upload Error","pleklang")):(plekerror.display_info(__("Gallery preview","pleklang"),plek_main.get_first_success_from_ajax_request(data)),jQuery(".image_to_upload.upload_complete img").removeClass("gallery-preview"),jQuery(img_element).addClass("gallery-preview")),plek_main.deactivate_loader_style(img_element)},error:function error(data){}})},image_upload_form_change_action(files_input){var image_container=jQuery("#images-uploaded-container");jQuery(image_container).html("");let files=jQuery("#review_images").prop("files"),existing_count=jQuery("#images-uploaded-container .image_to_upload").length;jQuery.each(files,(function(index,upload){if(index=existing_count+index,upload.size>plek_gallery_handler.max_upload_size)return void plekerror.display_error(null,__("Imagesize is to big for: ","pleklang")+upload.name,"Image upload error");jQuery(image_container).append(`<div id='image_${index}' class='image_to_upload'><img/>${upload.name}</div>`);var insert_image=jQuery(image_container).find("#image_"+index);let image;plek_main.get_preview_image(insert_image,upload)||plekerror.display_error(null,__("The given File is not a valid image","pleklang"),"Image upload error")}))},upload_image:async(index,formdata,gallery_id)=>(formdata.append("action","plek_ajax_gallery_actions"),formdata.append("do","add_image"),formdata.append("gallery_id",gallery_id),jQuery.ajax({url:ajaxurl,data:formdata,type:"POST",cache:!1,processData:!1,contentType:!1,async:!1,success:function success(data){console.log("uploaded");let success=!0;plek_main.response_has_errors(data)&&(success=!1,plekerror.display_error("",plek_main.get_first_error_from_ajax_request(data),__("Upload Error","pleklang")));let image_id=success?plek_main.get_first_success_from_ajax_request(data):0;return plek_gallery_handler.upload_image_progess_update(index,gallery_id,success,image_id),!0},error:function error(data){}})),upload_image_progess_update(index,gallery_id,is_success,image_id){let container="#images-uploaded-container",button=jQuery(`.image_upload_add_btn[data-gallery_id='${gallery_id}']`),button_status=jQuery(button).find(".image_upload_status"),item=jQuery(container+" #image_"+index),items_total=jQuery(container+" .image_to_upload").length;if(empty(item))return console.log("Preview Image not found!"),!1;is_success?(jQuery(item).addClass("upload_complete"),jQuery(item).attr("data-image_id",image_id)):jQuery(item).addClass("upload_failed"),jQuery(item).removeClass("upload_in_progress");let items_done=jQuery(container+" .image_to_upload.current_upload.upload_complete").length,items_failed,percentage_complete=(items_done+jQuery(container+" .image_to_upload.current_upload.upload_failed").length)/items_total*100,btn_text=__("Upload: ","pleklang")+Math.round(percentage_complete)+"%";jQuery("#review_images_upload_btn").text(btn_text);let old_count=jQuery(button).parent().find(".image_count .nr").text();jQuery(button).parent().find(".image_count .nr").text(parseInt(old_count)+1),100===percentage_complete&&(jQuery("#review_images").val(""),this.update_gallery_button_status(gallery_id,"done"),jQuery(container).find(".image_to_upload").removeClass("current_upload"),plek_main.deactivate_button_loader("#review_images_upload_btn",__("Upload images","pleklang")),plekerror.display_info(__("Image upload","pleklang"),__("Images uploaded: ","pleklang")+items_done))},get_band_gallery_sortorder(){var gallery_ids={};let container=jQuery("#event-review-images-container");return jQuery(container).find(".review_band_images_container").each((index,item)=>{let gallery_id=jQuery(item).find(".image_upload_add_btn ").attr("data-gallery_id"),album_id=jQuery(item).find(".image_upload_add_btn ").attr("data-album_id");empty(gallery_id)||(empty(gallery_ids[album_id])&&(gallery_ids[album_id]=[]),gallery_ids[album_id].push(gallery_id))}),gallery_ids}};plek_gallery_handler.construct();