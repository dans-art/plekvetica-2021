"use strict";let plek_band={default_button_texts:{},spotify_bands_found:null,construct(){jQuery("#plek-band-form").length>0?(empty(jQuery("#band-id").val())?(this.on_band_add(),this.on_edit_band()):this.on_edit_band(),jQuery(document).on("click",".band-social-icon",(function(){plek_band.show_social_input_field(this)})),jQuery(document).on("focusout","#band-link-spotify",(function(){plek_band.check_for_band_on_spotify(this)})),jQuery(document).on("focusout","#band-name",e=>{plek_band.search_bands_on_spotify(e.target)}),jQuery(document).on("click",'[data-form-id="band-link-spotify"]',e=>{plek_band.display_found_bands()}),jQuery(document).on("click",".spotify-artist-found-item button",e=>{const id=jQuery(e.target).data("spotify-id");plektemplate.remove_overlay("spotify_bands"),jQuery("#band-link-spotify").val(id),plek_band.check_for_band_on_spotify("#band-link-spotify")}),jQuery(document).ready(()=>{plek_band.on_bandform_ready()})):jQuery(document).on("click",".plek-follow-band-btn",(function(){plek_band.toggle_follower(this)}))},on_bandform_ready(){empty(jQuery("#band-link-spotify").val())&&!empty(jQuery("#band-name").val())&&plek_band.search_bands_on_spotify(jQuery("#band-name"))},on_edit_band(){jQuery(document).ready((function(){jQuery("select:not(.no-select2)").select2({theme:"plek"}),plek_band.show_youtube_videos()})),plek_band.default_button_texts.submit=jQuery("#band-form-submit").text(),jQuery("#plek-band-form button").click((function(e){if(e.preventDefault(),"band-form-cancel"===e.currentTarget.id){if(0===jQuery("#band-form-cancel").closest(".overlay_content").length)window.location=document.referrer;else{let overlay_id=jQuery("#band-form-cancel").closest(".overlay_content").parent().prop("id");overlay_id=overlay_id.replace("_overlay",""),plektemplate.hide_overlay(overlay_id)}return}let is_add_event=!empty(jQuery("#add_event_basic")),is_edit_event=!empty(jQuery("#edit_event_form"));if("band-form-submit"!==e.currentTarget.id||is_edit_event||is_add_event);else{var data=jQuery("#plek-band-form").serialize();plek_band.save_band(data)}})),jQuery(document).on("click",".remove_video",(function(){plek_band.remove_band_video(this)})),jQuery("#add-band-video").click((function(){plek_band.add_band_video()})),jQuery(document).on("keypress",(function(e){13==e.which&&plek_band.on_enter(e)})),jQuery("#band-name").on("change",e=>{plek_band.check_existing_band()})},on_band_add(){},on_enter(e){let focused=jQuery(":focus").attr("id");console.log(focused),"add-band-video-input"===focused&&(e.preventDefault(),jQuery("#add-band-video").click())},show_youtube_videos(id=null){if(jQuery("#band-videos").after('<div id="video_preview_con"></div>'),null===jQuery("#band-videos").val().length||0===jQuery("#band-videos").val().length){if(null===id)return!1;var videos=[id]}else var videos=jQuery("#band-videos").val().split("\n");jQuery(videos).each((function(i,val){empty(val)||plek_band.load_youtube_video(val,i)}))},get_youtube_video_id(url){const video_id_length=11;let parms=new URLSearchParams(url),video_id=url;for(const[key,value]of parms.entries()){if(key.indexOf("watch")>-1&&url.indexOf("watch?v=")>-1){video_id=value;break}if(key.indexOf("watch")>-1&&url.indexOf("watch?vi=")>-1){video_id=value;break}if("http://youtube.com/?v"===key){video_id=value;break}if("https://youtube.com/?v"===key){video_id=value;break}if("http://www.youtube.com/?v"===key){video_id=value;break}if("http://youtube.com/?vi"===key){video_id=value;break}if(key.indexOf("ytscreeningroom")>-1){video_id=value;break}if("v"===key){video_id=value;break}}if(11===video_id.length)return video_id;const url_parts=video_id.split("/");if(url_parts.length>1)for(let i=0;i<url_parts.length;i++){const value=url_parts[i];"v"!==value&&"vi"!==value&&"youtu.be"!==value&&"embed"!==value&&"e"!==value||(video_id=url_parts[i+1])}const split_id=video_id.split("?"),split_hash=split_id[0].split("#");let clean_id=split_hash[0].split("&");return 11===clean_id[0].length&&clean_id[0]},async load_youtube_video(video_id,item_id){var data=new FormData;if(0===video_id.length)return!1;data.append("action","plek_band_actions"),data.append("do","get_youtube_video"),data.append("video_id",video_id);let loading='<div class="loading-youtube">'+__("Loading Video","plekvetica")+"</div>";return jQuery("#video_preview_con").append('<div class="video_preview_item" id="video_'+item_id+'" data-videoid="'+video_id+'">'+loading+"</div>"),jQuery.ajax({url:window.ajaxurl,type:"POST",cache:!1,data:data,processData:!1,contentType:!1,success:function success(data){console.log("success");let cancel_btn='<span class="remove_video" data-videoid="'+video_id+'" data-itemid="'+item_id+'"><i class="fas fa-times"></i></span>';return 0===data.length?(jQuery("#video_preview_con .video_preview_item").last().remove(),plekerror.display_info(__("Info","plekvetica"),__("Video not found. Maybe the Video is private or the ID is incorrect","plekvetica")),!1):(jQuery("#video_"+item_id).html(cancel_btn+data),!0)},error:function error(data){return console.log(data),!1}})},async add_band_video(){let new_vid=jQuery("#add-band-video-input").val();const new_vid_yt_id=plek_band.get_youtube_video_id(new_vid);jQuery("#add-band-video-input").val("");const videos=jQuery("#band-videos").val();if(videos.search(new_vid_yt_id)>-1)return plekerror.display_info(__("Info","plekvetica"),__("Youtube Video already added","plekvetica")),!1;let videos_arr=videos.split("\n");var item_id=videos.length;const loaded_video=await plek_band.load_youtube_video(new_vid_yt_id,item_id);if(loaded_video.length>0){videos_arr.push(new_vid_yt_id);let vid_join=videos_arr.join("\n");jQuery("#band-videos").val(vid_join)}return!0},remove_band_video(item){jQuery(item).parent().remove(),console.log(item);let id=jQuery(item).data("itemid");var videos=jQuery("#band-videos").val().split("\n");jQuery(videos).each((function(i,val){i==id&&(console.log("found"+i),videos.splice(i))})),console.log(videos);let vid_join=videos.join("\n");console.log(vid_join),jQuery("#band-videos").val(vid_join)},save_band(data){plek_main.activate_button_loader("#band-form-submit",__("Save Band...","plekvetica")),plek_main.remove_field_errors();let button=jQuery("#band-form-submit"),form=document.getElementById("plek-band-form");var data=this.prepare_band_data(form);jQuery.ajax({url:window.ajaxurl,type:"POST",cache:!1,processData:!1,contentType:!1,data:data,success:function success(data){let text="",errors=plek_main.show_field_errors(data,form);if(!0===errors)console.log("Contains Errors"),text="Das Formular enthÃ¤lt Fehler, bitte korrigieren";else{text=plek_main.get_first_success_from_ajax_request(data);let band_obj=plek_main.get_ajax_success_object(data);void 0!==band_obj[1]&&band_obj[2]}plek_main.deactivate_button_loader(button,text),0===jQuery(".band-edit").length&&!1===errors&&plek_main.clear_form_inputs("plek-band-form"),jQuery("#band-form-cancel").text(__("Back","plekvetica")),setTimeout(()=>{jQuery("#band-form-submit").text(plek_band.default_button_texts.submit)},5e3)},error:function error(data){plek_main.deactivate_button_loader(button,__("Error loading data. ","plekvetica"))}})},check_existing_band(){if(!empty(jQuery("#band-name").val())){var data=new FormData;data.append("action","plek_band_actions"),data.append("do","check_existing_band"),data.append("band-name",jQuery("#band-name").val()),data.append("band-id",jQuery("#band-id").val()),jQuery.ajax({url:window.ajaxurl,type:"POST",cache:!1,processData:!1,contentType:!1,data:data,success:function success(data){let error=plek_main.get_first_error_from_ajax_request(data);empty(error)||(plekerror.set_toastr(0,!0),plekerror.display_info(__("Info","plekvetica"),error),plekerror.reset_toastr())},error:function error(data){plek_main.deactivate_button_loader(button,__("Error loading data. ","plekvetica"))}})}},prepare_band_data(form){var data=new FormData(form);data.append("action","plek_band_actions"),data.append("do","save_band");var file_data=jQuery("#band-logo").prop("files")[0];return data.delete("band-description"),data.append("band-description",tinymce.editors["band-description"].getContent()),data.append("band-logo-data",file_data),data.append("band-logo","666"),data.set("band-link-youtube",this.get_id_from_url(data.get("band-link-youtube"),"youtube")),data.set("band-link-spotify",this.get_id_from_url(data.get("band-link-spotify"),"spotify")),data},band_image_is_placeholder(){let image_url,image_parts=jQuery("#band-logo-image img").attr("src").split("/");return"default_placeholder.jpg"===image_parts[image_parts.length-1]},get_id_from_url(url,site){switch(site){case"youtube-deactivated":var input_arr,channel_index=(input_arr=url.split("/")).findIndex(element=>"channel"===element);if(-1===channel_index){var yt_index=input_arr.findIndex(ele=>"youtube.com"===ele||"www.youtube.com"===ele);return-1!==yt_index?input_arr[yt_index+1]:url}return input_arr[channel_index+1];case"spotify":var input_arr,artist_index=(input_arr=url.split("/")).findIndex(element=>"artist"===element);if(-1!==artist_index){const id_plus_params=input_arr[artist_index+1],split_params=id_plus_params.split("?");return split_params[0]}}return url},toggle_follower(){let band_id=jQuery(".band-single").data("band_id");plek_main.remove_field_errors();let button=jQuery(".plek-follow-band-btn");plek_main.activate_loader_style(button);var data=new FormData;data.append("action","plek_band_actions"),data.append("do","follow_band_toggle"),data.append("band_id",band_id),jQuery.ajax({url:window.ajaxurl,type:"POST",cache:!1,processData:!1,contentType:!1,data:data,success:function success(data){plek_main.deactivate_loader_style(button);let text=plek_main.get_text_from_ajax_request(data,!0),errors;if(!0===plek_main.response_has_errors(data))console.log("Contains Errors"),text=plek_main.get_first_error_from_ajax_request(data);else{let success=plek_main.get_ajax_success_object(data);text=success[1],jQuery(".plek-follow-band-btn .counter").text(success[0])}jQuery(".plek-follow-band-btn .label").text(text)},error:function error(data){plek_main.deactivate_loader_style(button),jQuery(".plek-follow-band-btn .label").text("Error loading data.")}})},get_spotify_artist(artist_id){if(empty(document.spotify))return console.log("Spotify not loaded"),!1;document.spotify.getArtist(artist_id).then((function(data){}),(function(error){console.error(error),plekerror.display_spotify_error_message(error)}))},show_social_input_field(item){let form_id=jQuery(item).data("form-id");"none"!==jQuery("#"+form_id+"-container").css("display")&&jQuery("#"+form_id+"-container input").addClass("plek-input-highlight"),jQuery("#"+form_id+"-container").css("display","flex")},drop_the_link_like_its_hot(event){event.preventDefault();const button=event.currentTarget},check_for_band_on_spotify(item){let input=jQuery(item).val();if(empty(input))return!1;input.includes("/")&&(input=plek_band.get_id_from_url(input,"spotify")),document.spotify.getArtist(input).then((function(data){if(empty(jQuery("#band-name").val())&&jQuery("#band-name").val(data.name),jQuery("#band-name").val()==data.name||empty(jQuery("#band-name").val())||plekerror.display_info("Spotify",sprintf(__("Name missmatch. The Artist ID you provided does not match with the given name.<br/>Band form Spotify: %s","plekvetica"),data.name)),empty(jQuery("#band-logo").val())&&!0===plek_band.band_image_is_placeholder()||jQuery("#band-logo-image img").attr("src").search("scdn.co/image")>0){let band_image=data.images[0].url;console.log(band_image),jQuery("#band-logo-url").val(band_image),jQuery("#band-logo-image img").attr("src",band_image)}let band_infos={id:data.id,name:data.name,popularity:data.popularity,followers:data.followers.total,image:data.images[0].url};jQuery("#band-infos").val(JSON.stringify(band_infos))}),(function(error){console.error(error),plekerror.display_spotify_error_message(error)}))},search_bands_on_spotify(item){let input=jQuery(item).val();if(empty(input))return!1;document.spotify.searchArtists(input,{limit:10}).then((function(data){plek_band.spotify_bands_found=data,console.log("Spotify Bands found")}),(function(error){console.error(error),plekerror.display_spotify_error_message(error)}))},display_found_bands(){if(empty(plek_band.spotify_bands_found)||empty(plek_band.spotify_bands_found.artists.items))return;let bands_html="";const band_found_title="<h2>"+__("Bands found on Spotify","plekvetica")+"</h2>";for(const[key,value]of plek_band.spotify_bands_found.artists.items.entries()){if("artist"!==value.type)return;const add_button_text=__("Add","plekvetica"),genres=value.genres.join(", "),image=empty(value.images)||empty(value.images[0].url)?"":value.images[0].url,item=`<div class="spotify-artist-found-item">\n            <div class="spotify-artist-image"><img src="${image}" /></div>\n            <div class="spotify-artist-data">\n                <div class="spotify-artist-name"><h3>${value.name}</h3></div>\n                <div class="spotify-artist-genres">${genres}</div>\n            </div>\n            <button class="plek-button" data-spotify-id="${value.id}">${add_button_text}</button>\n            </div>`;bands_html+=item}plektemplate.add_overlay("spotify_bands",band_found_title+bands_html,__("Dismiss suggestions","plekvetica")),plektemplate.show_overlay("spotify_bands")}};plek_band.construct();