var plekevent={existing_event:null,construct(){plekevent.add_events_listener()},add_events_listener(){jQuery("#event_start_date").on("change",(function(){window.plekevent.check_existing_event()}))},check_existing_event(){if(this.is_edit_event())return null;if(""!==this.get_field_value("event_start_date")&&jQuery("#event-band-selection .item").length>0){var datab=new FormData;datab.append("action","plek_ajax_event_form"),datab.append("type","check_event_duplicate"),datab.append("start_date",this.get_field_value("event_start_date")),datab.append("band_ids",this.get_field_value("event_band")),console.log(datab),jQuery.ajax({url:window.ajaxurl,data:datab,type:"POST",cache:!1,processData:!1,contentType:!1,success:function success(data){var jdata=JSON.parse(data);return jdata.error.length>0?(window.plekerror.set_toastr(0,!0,"toast-bottom-full-width"),window.plekerror.display_info(__("Event already exists","plekvetica"),jdata.error),window.plekerror.reset_toastr(),plekevent.existing_event=!0,console.log("Event Existiert bereits"),!0):(plekevent.existing_event=!1,console.log("Event existiert nicht"),!1)},error:function error(data){return window.plekerror.display_info(window.plekvetica.loaderror+": "+data,"Error"),!1}})}return null},add_new_vob_to_selection(type,vob_id,data){switch(type){case"band-form-submit":window.bandPreloadedData=data;let band=window.bandPreloadedData[vob_id],ele_b=plektemplate.load_band_item_template(band);this.add_item_to_selection(ele_b),plekerror.display_info(__("Add Band","plekvetica"),__("The Band has been added to the Database","plekvetica"));break;case"venue-form-submit":window.venuePreloadedData=data;let venue=window.venuePreloadedData[vob_id],ele_v=plektemplate.load_venue_item_template(venue);this.add_item_to_selection(ele_v),plekerror.display_info(__("Add Venue","plekvetica"),__("The Venue has been added to the Database","plekvetica"));break;case"organizer-form-submit":window.organizerPreloadedData=data;let organizer=window.organizerPreloadedData[vob_id],ele_o=plektemplate.load_organizer_item_template(organizer);this.add_item_to_selection(ele_o),plekerror.display_info(__("Add Organizer","plekvetica"),__("The Organizer has been added to the Database","plekvetica"));break;default:return!1}return!0},add_item_to_selection(element){var item_for=jQuery(element).data("for"),type=jQuery(element).data("type"),item_id=jQuery(element).data("id"),html=jQuery(element).html();let vob_timestamp=jQuery(element).data("timestamp"),vob_sort=jQuery(element).data("sort");var data={id:item_id,html:html,timestamp:vob_timestamp,sort:vob_sort},data_to_insert=plektemplate.get_item_to_add(data);"event_venue"===type&&this.remove_all_items("event-venue-selection"),0===jQuery(`#${item_for} .plek-select-item[data-id='${item_id}']`).length?void 0!==vob_timestamp&&0!==vob_timestamp?(this.vob_insert_with_timestamp(item_id,item_for,data_to_insert,vob_timestamp),console.log("Add item with timestamp: "+item_for)):void 0!==vob_sort?this.vob_insert_with_sort(item_id,item_for,data_to_insert,vob_sort):(console.log("Add item without timestamp or sort: "+item_for),jQuery("#"+item_for).append(data_to_insert)):console.log(item_id+" already added (VOB)"),plektemplate.hide_overlay(),jQuery("#"+type).val(""),plekevent.add_remove_item_eventlistener(),"event_band"===type&&(this.is_edit_event()||(window.plekevent.check_existing_event(),window.plekevent.generate_title()),this.set_band_time_flatpickr(item_id))},vob_insert_with_timestamp(item_id,item_for,data_to_insert,vob_timestamp){0!==jQuery("#"+item_for+" .plek-select-item").length?(jQuery("#"+item_for+" .plek-select-item").each((function(i,e){let ts;if(jQuery(e).data("timestamp")>vob_timestamp)return console.log("insert: "+item_for+" on index"+i),jQuery(data_to_insert).insertBefore(e),!1})),0===jQuery(`.plek-select-item[data-id='${item_id}']`).length&&jQuery("#"+item_for).append(data_to_insert)):jQuery("#"+item_for).append(data_to_insert)},vob_insert_with_sort(item_id,item_for,data_to_insert,vob_sort){0!==jQuery("#"+item_for+" .plek-select-item").length?(jQuery("#"+item_for+" .plek-select-item").each((function(i,e){let sort_index;jQuery(e).data("sort")>vob_sort&&jQuery(data_to_insert).insertBefore(e)})),0===jQuery(`.plek-select-item[data-id='${item_id}']`).length&&jQuery("#"+item_for).append(data_to_insert)):jQuery("#"+item_for).append(data_to_insert)},set_band_time_flatpickr(item_id=null){let defaultStartDate="2020-01-01",last_item=jQuery(".band-time-input").last().val();if(this.set_flatpickr_band_time_options(),empty(jQuery("#event-band-selection #band-time-"+item_id)))console.log("Update all Bandtimes"),jQuery("#event-band-selection .band-time-input").each((index,item)=>{if(!empty(jQuery(item).attr("name"))){0==jQuery(item).val()?jQuery(item).val("2020-01-01"):this.update_band_timestamp(item);try{plek_manage_event.flatpickr_band_options.defaultDate=plekevent.get_band_default_date(jQuery(item).closest(".plek-select-item")),jQuery(item).flatpickr(plek_manage_event.flatpickr_band_options)}catch(error){console.log(error)}}}),"0"!==last_item?jQuery("#event-band-selection .plek-select-item").each((function(index,item){plekevent.update_band_playtime_button_text(item)})):console.log("Last item triggered");else{plek_manage_event.flatpickr_band_options.defaultDate=plekevent.get_band_default_date(`#event-band-selection .plek-select-item[data-id='${item_id}']`);try{jQuery("#event-band-selection #band-time-"+item_id).flatpickr(plek_manage_event.flatpickr_band_options)}catch(error){console.error("Flatpickr not loaded")}plekevent.update_band_playtime_button_text(`#event-band-selection .plek-select-item[data-id='${item_id}']`)}},update_band_timestamp(item){let current_value=jQuery(item).val();if("00:00"!==current_value){let start_date=plekevent.get_event_date("event_start_date","date");5===current_value.length&&(current_value=start_date+" "+current_value);let date=new Date(current_value),timestamp_in_seconds=(date.getTime()-6e4*date.getTimezoneOffset())/1e3;jQuery(item).closest(".plek-select-item").data("timestamp",timestamp_in_seconds),console.log("Set timestamp to: "+timestamp_in_seconds)}},get_band_default_date(item){let timestamp=jQuery(item).data("timestamp");return this.event_is_single_day()?empty(timestamp)?"19:00":plek_main.get_formated_date(timestamp,"H:i"):empty(timestamp)?this.get_event_date("event_start_date","datetime"):plek_main.get_formated_date(timestamp,"Y-m-d H:i:s")},update_band_playtime_button_text(item){let unix_timestamp=jQuery(item).data("timestamp"),js_date;if(1970===new Date(1e3*unix_timestamp).getFullYear())return jQuery(item).find(".time-label").html('<i class="far fa-clock"></i>'),!1;if(this.event_is_single_day())var time=plek_main.get_formated_date(unix_timestamp,"H:i");else var time=plek_main.get_formated_date(unix_timestamp,"d.m<br/>H:i");jQuery(item).find(".time-label").html(time)},set_flatpickr_band_time_options(){let defaultStartDate="2020-01-01",defaultEndDate="9020-01-01";var is_single_day=this.event_is_single_day();if(is_single_day)plek_manage_event.flatpickr_band_options.time_24hr=!0,plek_manage_event.flatpickr_band_options.dateFormat="H:i",plek_manage_event.flatpickr_band_options.altFormat="H:i",plek_manage_event.flatpickr_band_options.noCalendar=!0,plek_manage_event.flatpickr_band_options.enable=[{from:"00:00",to:"23:59"}];else{let startDate=this.get_event_date("event_start_date","date"),endDate=this.get_event_date("event_end_date","date");startDate=0===startDate.length?"2020-01-01":startDate,endDate=0===endDate.length?"9020-01-01":endDate,plek_manage_event.flatpickr_band_options.dateFormat="Y-m-d H:i:S",plek_manage_event.flatpickr_band_options.altFormat="j.m H:i",plek_manage_event.flatpickr_band_options.noCalendar=!1,plek_manage_event.flatpickr_band_options.enable=[{from:startDate+" 00:00:00",to:endDate+" 23:59:59"}]}console.log("Set flatpicker time. Singleday: "+is_single_day)},add_remove_item_eventlistener(){jQuery(".remove-item").click((function(){jQuery(this).closest(".plek-select-item").remove(),plekevent.is_edit_event()||plekevent.generate_title()}))},remove_all_items(selector){jQuery("#"+selector+" .item").remove()},is_edit_event(){let id=this.get_field_value("event_id");return void 0!==id&&id.length>0},save_event(type,form){console.log("save "+type);var datab=this.prepare_data(type,form);if(!0!==plekvalidator.validate_form_data(datab,form))return jQuery("#"+form+" .plek-main-submit-button").prop("disabled",!1),plekvalidator.display_errors(form),!1;let button=jQuery("#"+form+" .plek-main-submit-button"),orig_btn_text=button.val();plek_main.activate_loader_style(button),jQuery.ajax({url:window.ajaxurl,data:datab,type:"POST",cache:!1,processData:!1,contentType:!1,success:function success(data){let text=plek_main.get_text_from_ajax_request(data,!0),errors;if(!0!==plek_main.show_field_errors(data,form)){let success_obj=plek_main.get_ajax_success_object(data),event_id=void 0!==success_obj[0]?success_obj[0]:"000",user_id=void 0!==success_obj[1]?success_obj[1]:0,event_url=void 0!==success_obj[2]?success_obj[2]:"";if("save_edit_event"===type)return plekerror.display_info(__("Event saved!","plekvetica")),plek_main.deactivate_button_loader(button,orig_btn_text),void jQuery(button).prop("disabled",!1);plek_main.url_replace_param("event_id",event_id);var stage="details";"save_basic_event"===type&&0===user_id&&(stage="login");let url=plek_main.url_replace_param("stage",stage);if("save_event_details"===type){if(0===user_id)plekerror.display_info(__("Event saved!","plekvetica"),__("Thanks a lot!<br/>Our Eventmanager will check and publish the Event","plekvetica"));else{let event_url_label,event_url_html=`<a href='${event_url}'>${__("To my Event","plekvetica")}</a>`;plekerror.display_info(__("Event saved!","plekvetica"),__("Check it out here: "+event_url_html,"plekvetica"))}plek_add_event_functions.remove_event_details_reminder(event_id)}else plekerror.display_info(__("Data saved!","plekvetica")),setTimeout(()=>{window.location=url},6e3),jQuery(button).data("type","new_event_next_page"),orig_btn_text=__("Add Event details","plekvetica"),jQuery(button).data("url",url);if("save_basic_event"===type){let event_name=jQuery("input#event_name").val();plek_add_event_functions.add_event_details_reminder(event_id,event_name,"login")}return plek_main.deactivate_button_loader(button,orig_btn_text),void jQuery(button).prop("disabled",!1)}console.log("Contains Errors"),plekerror.display_error(null,__("This form contains errors, please fix them.","plekvetica"),__("Form error","plekvetica")),plek_main.deactivate_button_loader(button,orig_btn_text),jQuery(button).prop("disabled",!1)},error:function error(data){plek_main.deactivate_button_loader(button,__("Error loading data. ","plekvetica"))}})},save_event_login(type){console.log("savelogin "+type);var form="add_event_login",datab=this.prepare_data(type,form);if(!0!==plekvalidator.validate_form_data(datab,form))return jQuery("#plek-add-login-submit").prop("disabled",!1),plekvalidator.display_errors(form),!1;jQuery.ajax({url:window.ajaxurl,data:datab,type:"POST",cache:!1,processData:!1,contentType:!1,success:function success(data){let errors;if(jQuery("#plek-add-login-submit").prop("disabled",!1),!0===plek_main.show_field_errors(data,"#add_event_login"))console.log("Contains Errors"),text="Das Formular enthält Fehler, bitte korrigieren";else{let success_obj=plek_main.get_ajax_success_object(data),event_id=void 0!==success_obj[0]?success_obj[0]:"000",user_id=void 0!==success_obj[1]?success_obj[1]:0;plek_add_event_functions.add_event_details_reminder(event_id,"","details"),plek_main.url_replace_param("event_id",event_id);let url=plek_main.url_replace_param("stage","details");window.location=url}},error:function error(data){return window.plekerror.display_info(window.plekvetica.loaderror+": "+data,"Error"),!1}})},save_review(){let datab=plekevent.prepare_data("save_event_review","edit_event_review_form"),form="edit_event_review_form",button=jQuery("#edit_event_review_form .plek-main-submit-button"),orig_btn_text=button.val();plek_main.activate_loader_style(button),jQuery.ajax({url:window.ajaxurl,data:datab,type:"POST",cache:!1,processData:!1,contentType:!1,success:function success(data){let text=plek_main.get_text_from_ajax_request(data,!0),errors;if(!0!==plek_main.show_field_errors(data,form)){let message=plek_main.get_first_success_from_ajax_request(data);return plekerror.display_info(__("Review status","plekvetica"),message),plek_main.deactivate_button_loader(button,orig_btn_text),jQuery(button).prop("disabled",!1),void plekerror.clear_field_errors()}console.log("Contains Errors"),text=__("The Review contains errors, please fix them.","plekvetica"),plekerror.display_error("",text,__("Review status","plekvetica")),plek_main.deactivate_button_loader(button,orig_btn_text),jQuery(button).prop("disabled",!1)},error:function error(data){plek_main.deactivate_button_loader(button,__("Error loading data. ","plekvetica"))}})},prepare_data(type,form){var datab=new FormData;if(datab.append("action","plek_ajax_event_form"),datab.append("type",type),"save_basic_event"===type||"save_edit_event"===type){datab.append("event_name",this.get_field_value("event_name")),datab.append("event_start_date",this.get_field_value("event_start_date")),!0===jQuery("#is_multiday").is(":checked")&&(plekvalidator.add_field("is_multiday","int",!0,form),plekvalidator.add_field("event_end_date","date",!0,form)),datab.append("is_multiday",!0===jQuery("#is_multiday").is(":checked")?"1":"0"),datab.append("event_end_date",this.get_field_value("event_end_date")),!0===jQuery("#no_band").is(":checked")?(datab.append("no_bands_known","true"),plekvalidator.add_field("event_band","int",!0,form)):plekvalidator.add_field("event_band","int",!1,form),datab.append("event_band",this.get_field_value("event_band")),datab.append("event_venue",this.get_field_value("event_venue")),datab.append("hp-password",this.get_field_value("hp-password"));let band_order_time=this.get_band_order_time();datab.append("band_order_time",band_order_time)}if("save_event_details"===type||"save_edit_event"===type){datab.append("event_description",this.get_field_value("event_description")),datab.append("event_organizer",this.get_field_value("event_organizer")),datab.append("event_poster",this.get_field_value("event_poster")),datab.append("event_fb_link",this.get_field_value("event_fb_link")),datab.append("event_price_boxoffice",this.get_field_value("event_price_boxoffice")),datab.append("event_currency",this.get_field_value("event_currency")),datab.append("event_price_presale",this.get_field_value("event_price_presale")),datab.append("event_price_link",this.get_field_value("event_price_link"));let event_id=this.get_field_value("event_id");datab.append("event_id",event_id)}if("save_add_event_login"===type){plek_manage_event.prepare_validator_fields();let selected_btn=jQuery("#select-login-type a.selected").attr("id");"add_login"===selected_btn?(datab.append("user_login",this.get_field_value("user_login")),datab.append("user_pass",this.get_field_value("user_pass")),datab.append("rememberme",this.get_field_value("rememberme"))):(datab.append("guest_name",this.get_field_value("guest_name")),datab.append("guest_email",this.get_field_value("guest_email"))),datab.append("event_id",this.get_event_id());let is_guest="add_as_guest"===selected_btn;datab.append("is_guest",is_guest)}return"save_edit_event"===type&&(datab.append("event_ticket_raffle",empty(this.get_field_value("event_ticket_raffle"))?"":this.get_field_value("event_ticket_raffle")),datab.append("event_ticket_raffle_conditions",empty(this.get_field_value("event_ticket_raffle_conditions"))?"":this.get_field_value("event_ticket_raffle_conditions")),datab.append("event_status",this.get_field_value("event_status")),datab.append("event_featured",this.get_field_value("event_featured")),datab.append("event_promote",this.get_field_value("event_promote")),datab.append("is_postponed_check",this.get_field_value("is_postponed_check")),datab.append("event_team",this.get_field_value("event_team"))),"save_event_review"===type&&(datab.append("event_id",this.get_field_value("event_id")),datab.append("event_text_lead",this.get_field_value("event_text_lead")),empty(this.get_field_value("review_old_album_id"))||datab.append("event_review_old_album_id",this.get_field_value("review_old_album_id")),datab.append("event_text_review",this.get_field_value("event_text_review")),datab.append("event_gallery_sortorder",JSON.stringify(plek_gallery_handler.get_band_gallery_sortorder())),datab.append("hp-password",this.get_field_value("hp-password"))),console.log("Added Validator fields for: "+type),datab},get_event_id(add_to_form=!0){let event_id=this.get_field_value("event_id");if(empty(event_id)){let prev_event=window.localStorage.getItem("plek_event_reminder");try{let prev_event_obj=JSON.parse(prev_event);event_id=empty(Object.keys(prev_event_obj)[0])?"":Object.keys(prev_event_obj)[0],console.log("Event ID loaded from Storage")}catch(error){console.log(error)}}return add_to_form&&jQuery("input#event_id").val(event_id),parseInt(event_id)},get_band_order_time(){let order_obj={},is_single_day_event=this.event_is_single_day();return jQuery("#event-band-selection .plek-select-item").each((index,item)=>{let band_id=jQuery(item).data("id"),datetime=jQuery(item).find(".band-time-input").first().val();if(is_single_day_event||datetime.length<6){let startDate;datetime=this.get_event_date("event_start_date","date")+" "+datetime}jQuery(item).find(".time-label").html().indexOf("clock")>0&&(datetime=0),order_obj[band_id]={order:index,datetime:datetime}}),JSON.stringify(order_obj)},event_is_single_day(){if(!1===jQuery("#is_multiday").is(":checked"))return!0;let startDate=jQuery("#event_start_date").val(),startDateArr=startDate.split(" "),endDate=jQuery("#event_end_date").val(),endDateArr=endDate.split(" ");if(0===endDate.length)return!0;if(startDateArr[0]===endDateArr[0])return!0;let startDD=new Date(startDate),endDD=new Date(endDate),nextDay=startDD.setTime(startDD.getTime()+576e5);return new Date(nextDay)>endDD},get_event_date(id=null,output="both"){let dateVal=jQuery("#"+id).val();if(void 0===dateVal)return"";let dateSplit=dateVal.split(" ");switch(output){case"date":return dateSplit[0];case"time":return void 0!==dateSplit[1]?dateSplit[1]:"";case"datetime":return jQuery("#"+id).val();default:return dateSplit}},get_field_value(name){let type=jQuery("#"+name).attr("type");switch(void 0===type&&(type=jQuery("#"+name).prop("type")),type){case"checkbox":return jQuery("#"+name+":checked").length>0?jQuery("#"+name).val():"";case"textarea":return void 0!==tinymce.editors[name]?tinymce.editors[name].getContent():(jQuery("#"+name+":checked").length,jQuery("#"+name).val());case"file":let file_data;return jQuery("#"+name).prop("files")[0]}switch(name){case"event_band":return this.get_selector_ids("event-band-selection");case"event_venue":return this.get_selector_ids("event-venue-selection");case"event_organizer":return this.get_selector_ids("event-organizer-selection");case"event_start_date":case"event_end_date":const date_data=jQuery("#"+name).val();if(empty(date_data))return date_data;const date=new Date(date_data);return plek_main.get_formated_date(date.getTime()/1e3,"Y-m-d H:i:s",!1);default:return jQuery("#"+name).val()}},get_selector_ids(selector_id){var ids=[],items=jQuery("#"+selector_id).find(".plek-select-item");return jQuery.each(items,(function(key,val){var id=jQuery(val).data("id");ids.push(id)})),0===Object.keys(ids).length?"":JSON.stringify(ids)},generate_title(){let selected_bands=jQuery("#event-band-selection .item");var title_input=jQuery("#event_name"),band_order=[];jQuery.each(selected_bands,(function(index){let id=jQuery(this).data("id"),band_name=bandPreloadedData[id].name.replace("&amp;","&"),band_score=parseInt(bandPreloadedData[id].score);band_order.push([band_score,band_name])})),band_order.sort((function(a,b){var a0=a[0],b0=b[0];return a0==b0?0:a0<b0?1:-1}));var total_items=band_order.length,event_name_text="",max_items=3;jQuery.each(band_order,(function(index){if(0!==index)return 3<index+2?(event_name_text+=" & "+this[1],!1):void(event_name_text+=index+1!==total_items?", "+this[1]:" & "+this[1]);event_name_text=this[1]})),jQuery(title_input).val(event_name_text)}};plekevent.construct();